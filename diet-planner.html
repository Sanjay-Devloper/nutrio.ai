<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DietApp - Weekly Meal Planner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: #1e1e1e;
      color: white;
    }

    .sidebar {
      width: 240px;
      background-color: #2ecc71;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      color: white;
      margin-bottom: 30px;
    }

    .sidebar a {
      color: white;
      padding: 10px;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 10px;
      display: block;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #27ae60;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      background-color: #1e1e1e;
      overflow-y: auto;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar h1 {
      text-align: center;
      flex: 1;
    }

    .nav-btn {
      background-color: #2ecc71;
      border: none;
      color: white;
      font-size: 18px;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    .diet-grid {
      display: grid;
      grid-template-columns: 150px repeat(7, 1fr);
      gap: 1px;
      background-color: #333;
      margin-top: 30px;
      font-size: 14px;
    }

    .cell {
      padding: 10px;
      text-align: center;
      min-height: 60px;
      color: white;
    }

    .header {
      background-color: #2ecc71;
      font-weight: bold;
    }

    .meal {
      background-color: #2ecc71;
      font-weight: bold;
    }

    .empty {
      background-color: #2c2c2c;
    }

    .day-name {
      font-weight: bold;
    }

    .date-label {
      font-size: 12px;
      color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>DietApp</h2>
    <a href="#" class="active">Meal Planner</a>
    <a href="#">Grocery List</a>
    <a href="#">Activity Time</a>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <button class="nav-btn" onclick="changeWeek(-1)">&#8592;</button>
      <h1>Weekly Diet Plan</h1>
      <button class="nav-btn" onclick="changeWeek(1)">&#8594;</button>
    </div>

    <div class="diet-grid" id="dietGrid">
      <!-- Grid dynamically inserted by JavaScript -->
    <!-- </div>
  </div>

  <script>
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const meals = ['Early Morning', 'Breakfast', 'Mid-Morning Snack', 'Lunch', 'Evening Snack', 'Pre-Dinner', 'Dinner'];
    let currentWeekOffset = 0;

    function generateGrid(startDate) {
      const grid = document.getElementById('dietGrid');
      grid.innerHTML = '';

      // Header row
      grid.innerHTML += `<div class="cell header">Meal</div>`;
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        grid.innerHTML += `<div class="cell header">
          <div class="day-name">${days[i]}</div>
          <div class="date-label">${date.toLocaleDateString('en-GB')}</div>
        </div>`;
      }

      // Meal rows
      meals.forEach(meal => {
        grid.innerHTML += `<div class="cell meal">${meal}</div>`;
        for (let i = 0; i < 7; i++) {
          grid.innerHTML += `<div class="cell empty"></div>`;
        }
      });
    }

    function getWeekStartDate(offset) {
      const now = new Date();
      const day = now.getDay();
      const mondayOffset = (day === 0 ? -6 : 1) - day;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset + offset * 7);
      return monday;
    }

    function changeWeek(direction) {
      const newOffset = currentWeekOffset + direction;
      if (newOffset < -2 || newOffset > 2) return;
      currentWeekOffset = newOffset;
      generateGrid(getWeekStartDate(currentWeekOffset));
    }

    // Initialize current week grid
    generateGrid(getWeekStartDate(currentWeekOffset));
  </script>
</body>
</html> --> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Personalized Diet Plan</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8fff8;
      color: #222;
      overflow-x: hidden;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      height: 100%;
      width: 250px;
      background-color: #1e1e1e;
      padding: 20px;
      transition: left 0.3s ease;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar h3 {
      margin-bottom: 20px;
      color: #4CAF50;
    }

    .sidebar a {
      display: block;
      margin-bottom: 10px;
      padding: 12px;
      background-color: #222;
      border-radius: 5px;
      text-decoration: none;
      color: white;
      transition: background-color 0.3s;
    }

    .sidebar a:hover {
      background-color: #444;
    }

    .menu-button {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100vh;
      background-color: #4CAF50;
      color: white;
      border: none;
      font-size: 24px;
      z-index: 1001;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .menu-button:hover {
      background-color: #388e3c;
    }

    .container {
      margin-left: 60px;
      padding: 20px;
    }

    h1 {
      color: #4CAF50;
      text-align: center;
      padding-top: 2rem;
    }

    p {
      text-align: center;
    }

    #dietResult {
      width: 90%;
      max-width: 1200px;
      margin: 2rem auto;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    h2 {
      color: #4CAF50;
      margin-top: 2rem;
    }

    ul {
      list-style-type: disc;
      padding-left: 1.5rem;
    }

    button {
      display: block;
      margin: 3rem auto;
      padding: 12px 24px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #388e3c;
    }
  </style>
</head>
<body>

  <!-- Menu Button -->
  <!-- <button class="menu-button" onclick="toggleSidebar()">☰</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3>Menu</h3>
    <a href="#">Grocery List</a>
    <a href="#">Activity Time</a>
    <a href="index.html">Home</a>
  </div>

  <!-- Main Content -->
  <div class="container">
    <h1>Your Personalized Diet Plan</h1>
    <p>Based on your inputs, here's your recommended plan:</p>

    <div id="dietResult">Generating your plan... Please wait.</div>

    <button onclick="window.location.href='index.html'">Start Over</button>
  <!-- </div>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'
  
    const supabase = createClient(
      'https://YOUR_PROJECT.supabase.co',
      'YOUR_ANON_KEY'
    )
  
    async function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
    }
  
    const userDataStr = localStorage.getItem("userData")
    const userData = userDataStr ? JSON.parse(userDataStr) : null
    const dietResult = document.getElementById("dietResult")
  
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      window.location.href = "auth.html"
    }
  
    // Try to fetch the latest saved plan
    const { data: saved, error } = await supabase
      .from("diet_plans")
      .select("*")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(1)
  
    let dietData
  
    if (saved.length > 0) {
      // Load saved plan
      dietData = saved[0].diet_data
      renderDiet(dietData)
    } else {
      // No saved plan → generate new one
      if (!userData) {
        dietResult.innerText = "User input not found. Please start again.";
        return;
      }
  
      try {
        const response = await fetch("http://localhost:8000/generate-diet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        })
  
        const result = await response.json()
        dietData = result.diet_plan
  
        if (!dietData) {
          dietResult.innerText = "No diet plan received.";
          return;
        }
  
        // Render new diet
        renderDiet(dietData)
  
        // Save to Supabase
        await supabase.from("diet_plans").insert({
          user_id: user.id,
          week_start: new Date().toISOString().slice(0, 10),
          diet_data: dietData
        })
  
      } catch (err) {
        dietResult.innerText = "Error: " + err.message
      }
    }
  
    function renderDiet(data) {
      let html = ""
      for (const day of ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]) {
        if (!data[day]) continue
        html += `<h2>${day}</h2><ul>`
        for (const [meal, description] of Object.entries(data[day])) {
          html += `<li><strong>${meal}:</strong> ${description}</li>`
        }
        html += "</ul>"
      }
      dietResult.innerHTML = html
    }
  </script> -->

</body> -->
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Personalized Diet Plan</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8fff8;
      color: #222;
      overflow-x: hidden;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      height: 100%;
      width: 250px;
      background-color: #1e1e1e;
      padding: 20px;
      transition: left 0.3s ease;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar h3 {
      margin-bottom: 20px;
      color: #4CAF50;
    }

    .sidebar a {
      display: block;
      margin-bottom: 10px;
      padding: 12px;
      background-color: #222;
      border-radius: 5px;
      text-decoration: none;
      color: white;
      transition: background-color 0.3s;
    }

    .sidebar a:hover {
      background-color: #444;
    }

    .menu-button {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100vh;
      background-color: #4CAF50;
      color: white;
      border: none;
      font-size: 24px;
      z-index: 1001;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .menu-button:hover {
      background-color: #388e3c;
    }

    .container {
      margin-left: 60px;
      padding: 20px;
    }

    h1 {
      color: #4CAF50;
      text-align: center;
      padding-top: 2rem;
    }

    p {
      text-align: center;
    }

    #dietResult {
      width: 90%;
      max-width: 1200px;
      margin: 2rem auto;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    h2 {
      color: #4CAF50;
      margin-top: 2rem;
    }

    ul {
      list-style-type: disc;
      padding-left: 1.5rem;
    }

    button {
      display: block;
      margin: 3rem auto;
      padding: 12px 24px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #388e3c;
    }
  </style>
</head>
<body>

  <!-- Menu Button -->
  <button class="menu-button" onclick="toggleSidebar()">☰</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3>Menu</h3>
    <a href="grocery_list.html">Grocery List</a>
    <a href="#">Activity Time</a>
    <a href="diet_calendar.html">Diet Calendar</a>
    <a href="index.html">Home</a>
  </div>

  <!-- Main Content -->
  <div class="container">
    <h1>Your Personalized Diet Plan</h1>
    <p>Based on your inputs, here's your recommended plan:</p>
    <div id="dietResult">Generating your plan... Please wait.</div>
    <button onclick="window.location.href='index.html'">Start Over</button>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://lbhxjtnsdydpdglqqsuy.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaHhqdG5zZHlkcGRnbHFxc3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDE2NjUsImV4cCI6MjA2NjMxNzY2NX0.aTINbxO-X-ivhO9iFAVVEggfLM9s1666W-SWnKimCd4'
    );

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
    }

    async function fetchDietPlan() {
      const userDataStr = localStorage.getItem("userData");
      if (!userDataStr) {
        document.getElementById("dietResult").innerText =
          "User data not found. Please go back and enter your details.";
        return;
      }

      const userData = JSON.parse(userDataStr);

      try {
        const response = await fetch("http://localhost:8000/generate-diet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData),
        });

        const result = await response.json();
        const dietData = result.diet_plan;

        if (!dietData) {
          document.getElementById("dietResult").innerText = "No diet plan received.";
          return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        const weekStart = new Date().toISOString().split('T')[0];

        await supabase.from("diet_plans").insert([
          {
            user_id: user.id,
            week_start: weekStart,
            diet_data: dietData,
          },
        ]);

        renderDietPlan(dietData);
      } catch (error) {
        console.error("Fetch error:", error);
        document.getElementById("dietResult").innerText = "Error: " + error.message;
      }
    }

    async function fetchOrLoadSavedPlan() {
      const { data: { user } } = await supabase.auth.getUser();
      const today = new Date().toISOString().split('T')[0];

      const { data, error } = await supabase
        .from('diet_plans')
        .select('diet_data')
        .eq('user_id', user.id)
        .eq('week_start', today)
        .single();

      if (data && data.diet_data) {
        renderDietPlan(data.diet_data);
      } else {
        fetchDietPlan();
      }
    }

    function renderDietPlan(dietData) {
      let html = "";
      for (const day in dietData) {
        html += `<h2>${day}</h2><ul>`;
        for (const [meal, desc] of Object.entries(dietData[day])) {
          html += `<li><strong>${meal}:</strong> ${desc}</li>`;
        }
        html += "</ul>";
      }
      document.getElementById("dietResult").innerHTML = html;
    }

    // Kick off fetch or load
    fetchOrLoadSavedPlan();
  </script>

</body>
</html>
